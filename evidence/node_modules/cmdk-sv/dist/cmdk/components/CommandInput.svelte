<script>import { derived } from "svelte/store";
import { ITEM_SELECTOR, VALUE_ATTR, getCtx, getState } from "../command.js";
import { addEventListener, isBrowser, isHTMLInputElement } from "../../internal/index.js";
import { sleep } from "../../internal/helpers/sleep.js";
const { ids, commandEl } = getCtx();
const state = getState();
const search = derived(state, ($state) => $state.search);
const valueStore = derived(state, ($state) => $state.value);
export let autofocus = void 0;
export let value = $search;
export let asChild = false;
export let el = void 0;
const selectedItemId = derived([valueStore, commandEl], ([$value, $commandEl]) => {
  if (!isBrowser)
    return void 0;
  const item = $commandEl?.querySelector(`${ITEM_SELECTOR}[${VALUE_ATTR}="${$value}"]`);
  return item?.getAttribute("id");
});
function handleValueUpdate(v) {
  state.updateState("search", v);
}
function action(node) {
  if (autofocus) {
    sleep(10).then(() => node.focus());
  }
  const unsubEvents = addEventListener(node, "change", (e) => {
    if (!isHTMLInputElement(e.target))
      return;
    state.updateState("search", e.target.value);
  });
  return {
    destroy: unsubEvents
  };
}
$:
  handleValueUpdate(value);
let attrs;
$:
  attrs = {
    type: "text",
    "data-cmdk-input": "",
    autocomplete: "off",
    autocorrect: "off",
    spellcheck: false,
    "aria-autocomplete": "list",
    role: "combobox",
    "aria-expanded": true,
    "aria-controls": ids.list,
    "aria-labelledby": ids.label,
    "aria-activedescendant": $selectedItemId ?? void 0,
    id: ids.input
  };
</script>

{#if asChild}
	<slot {action} {attrs} />
{:else}
	<input
		bind:this={el}
		{...attrs}
		bind:value
		use:action
		{...$$restProps}
		on:input
		on:focus
		on:blur
		on:change
	/>
{/if}
